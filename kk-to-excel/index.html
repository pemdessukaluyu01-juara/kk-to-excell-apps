<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KK to Excel - Desa Sukaluyu</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.344.0/dist/umd/lucide.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .transition-all { transition: all 0.3s ease; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (iconRef.current && window.lucide) {
                    iconRef.current.innerHTML = '';
                    const iconData = window.lucide.icons[name];
                    if (iconData) {
                        window.lucide.createIcons({
                            icons: { [name]: iconData },
                            attrs: { strokeWidth: 2, width: size, height: size, class: className }
                        });
                    }
                }
            }, [name, size, className]);
            return <span ref={iconRef} className="inline-flex items-center"></span>;
        };

        const App = () => {
            const [loading, setLoading] = useState(false);
            const [dataMaster, setDataMaster] = useState([]);
            const [statusMsg, setStatusMsg] = useState({ type: '', text: '' });
            const [showSettings, setShowSettings] = useState(false);
            
            // Menggunakan API Key Baru dari User
            const [userApiKey, setUserApiKey] = useState("AIzaSyAQxVman0_RjC4aCKvsfko-zvYKraFFJrc");

            useEffect(() => {
                const savedKey = localStorage.getItem("gemini_api_key_v3");
                if (savedKey) {
                    setUserApiKey(savedKey);
                }
            }, []);

            const saveApiKey = (val) => {
                setUserApiKey(val);
                localStorage.setItem("gemini_api_key_v3", val);
            };

            const extractData = async (base64) => {
                if (!userApiKey || userApiKey.trim() === "") {
                    setStatusMsg({ type: 'error', text: 'API Key kosong! Silakan isi di menu Pengaturan.' });
                    setShowSettings(true);
                    return;
                }

                setLoading(true);
                setStatusMsg({ type: 'info', text: 'AI sedang mengekstrak data...' });

                const systemPrompt = `Ekstrak data dari foto Kartu Keluarga ke JSON. 
                Wajib menyertakan: no_kk, dan list anggota dengan nik, nama, kelamin, tgl_lahir (format DD-MM-YYYY), agama, pendidikan, pekerjaan, gol_darah. 
                Output harus JSON murni tanpa markdown.`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: "Ekstrak data tabel anggota keluarga dari gambar ini seakurat mungkin." },
                                    { inlineData: { mimeType: "image/jpeg", data: base64.split(',')[1] } }
                                ]
                            }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                    const res = await response.json();
                    
                    if (res.error) {
                        if (res.error.message.includes("leaked") || res.error.status === "PERMISSION_DENIED") {
                            throw new Error("API Key bermasalah atau bocor. Silakan ganti dengan Key baru di Pengaturan.");
                        }
                        throw new Error(res.error.message);
                    }

                    const text = res.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        const parsed = JSON.parse(text);
                        const startNo = dataMaster.length + 1;
                        
                        const newRows = (parsed.anggota || []).map((p, i) => ({
                            "No Urut": startNo + i,
                            "no_kk(*+16 digit)": `*${parsed.no_kk || ""}`,
                            "nik_ktp(*+16 digit)": `*${p.nik || ""}`,
                            "nama": (p.nama || "").toUpperCase(),
                            "kelamin": (p.kelamin || "").toUpperCase(),
                            "alamat": "DUSUN KALIPANDAN",
                            "rt": "001",
                            "rw": "001",
                            "tgl_lahir": p.tgl_lahir || "",
                            "agama": (p.agama || "ISLAM").toUpperCase(),
                            "pendidikan": (p.pendidikan || "").toUpperCase(),
                            "status_tinggal": "Menetap",
                            "pekerjaan": (p.pekerjaan || "").toUpperCase(),
                            "golongan darah": (p.gol_darah || "TIDAK TAHU").toUpperCase(),
                            "Kewarganegaraan": "WNI",
                            "Keterangan": ""
                        }));

                        setDataMaster(prev => [...prev, ...newRows]);
                        setStatusMsg({ type: 'success', text: `Berhasil menambahkan ${parsed.anggota?.length || 0} warga.` });
                    }
                } catch (e) {
                    setStatusMsg({ type: 'error', text: 'Gagal: ' + e.message });
                } finally {
                    setLoading(false);
                }
            };

            const handleFile = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const r = new FileReader();
                    r.onload = () => extractData(r.result);
                    r.readAsDataURL(file);
                }
            };

            const exportExcel = () => {
                if (dataMaster.length === 0) return;
                const ws = XLSX.utils.json_to_sheet(dataMaster);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Master Warga");
                XLSX.writeFile(wb, `Export_Warga_Sukaluyu_${new Date().getTime()}.xlsx`);
            };

            return (
                <div className="max-w-5xl mx-auto p-6 md:p-12">
                    
                    {/* Header */}
                    <div className="flex justify-between items-center mb-12">
                        <div>
                            <h1 className="text-3xl font-extrabold tracking-tight text-slate-900">KK to Excel</h1>
                            <p className="text-slate-400 text-sm font-medium uppercase tracking-widest">Desa Sukaluyu Digital</p>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setShowSettings(true)} className="p-3 text-slate-300 hover:text-indigo-600 transition-all border border-transparent hover:border-slate-100 rounded-2xl">
                                <Icon name="Settings" />
                            </button>
                            <button onClick={() => { if(confirm('Hapus semua data di tabel?')) setDataMaster([]); }} className="p-3 text-slate-300 hover:text-red-500 transition-all border border-transparent hover:border-slate-100 rounded-2xl">
                                <Icon name="Trash2" />
                            </button>
                        </div>
                    </div>

                    {/* Area Upload */}
                    <div className="mb-10">
                        <input type="file" id="upload" className="hidden" onChange={handleFile} disabled={loading} accept="image/*" />
                        <label htmlFor="upload" className={`flex flex-col items-center justify-center w-full h-56 border-2 border-dashed rounded-[2.5rem] cursor-pointer transition-all ${loading ? 'bg-slate-50 border-slate-200' : 'bg-white border-slate-200 hover:border-indigo-400 hover:bg-indigo-50/20'}`}>
                            {loading ? (
                                <div className="text-center">
                                    <Icon name="Loader2" className="animate-spin text-indigo-600 mb-4" size={40} />
                                    <p className="text-[10px] font-black uppercase tracking-[0.2em] text-indigo-500">Menganalisa Data...</p>
                                </div>
                            ) : (
                                <div className="text-center">
                                    <div className="bg-indigo-50 p-5 rounded-3xl inline-block mb-4">
                                        <Icon name="Upload" className="text-indigo-600" size={32} />
                                    </div>
                                    <p className="text-sm font-bold text-slate-700">Upload Foto Kartu Keluarga</p>
                                    <p className="text-[10px] text-slate-400 mt-2 font-medium">PASTIKAN HASIL FOTO TERANG DAN JELAS</p>
                                </div>
                            )}
                        </label>
                        {statusMsg.text && (
                            <div className={`mt-6 text-center text-[10px] font-black uppercase tracking-[0.2em] px-6 py-4 rounded-3xl border ${statusMsg.type === 'error' ? 'bg-red-50 text-red-500 border-red-100' : 'bg-emerald-50 text-emerald-600 border-emerald-100'}`}>
                                {statusMsg.text}
                            </div>
                        )}
                    </div>

                    {/* Tabel */}
                    <div className="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden">
                        <div className="p-8 border-b border-slate-50 flex flex-col md:flex-row justify-between items-center bg-slate-50/20 gap-4">
                            <div>
                                <h2 className="text-[10px] font-black uppercase tracking-widest text-slate-400">Database Preview</h2>
                                <p className="text-lg font-bold text-slate-800">{dataMaster.length} Jiwa Terdeteksi</p>
                            </div>
                            <button 
                                onClick={exportExcel}
                                disabled={dataMaster.length === 0}
                                className="bg-indigo-600 text-white px-8 py-3.5 rounded-2xl text-[11px] font-black uppercase tracking-widest hover:bg-indigo-700 transition-all disabled:opacity-30 flex items-center gap-2 shadow-xl shadow-indigo-100"
                            >
                                <Icon name="FileDown" size={16} /> Download Excel
                            </button>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left text-sm">
                                <thead className="text-[10px] text-slate-400 font-black uppercase border-b border-slate-50">
                                    <tr>
                                        <th className="px-8 py-6">No</th>
                                        <th className="px-8 py-6">Nama</th>
                                        <th className="px-8 py-6">NIK / No. KK</th>
                                        <th className="px-8 py-6 text-right">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50">
                                    {dataMaster.length === 0 ? (
                                        <tr><td colSpan="4" className="py-24 text-center text-slate-300 font-bold uppercase text-[10px] tracking-[0.4em]">Belum ada data</td></tr>
                                    ) : (
                                        dataMaster.map((item, i) => (
                                            <tr key={i} className="hover:bg-slate-50/50 transition-colors">
                                                <td className="px-8 py-6 text-slate-300 font-bold">{i+1}</td>
                                                <td className="px-8 py-6">
                                                    <p className="font-bold text-slate-700 uppercase tracking-tight">{item.nama}</p>
                                                    <p className="text-[9px] text-slate-400 uppercase font-medium">{item.pekerjaan}</p>
                                                </td>
                                                <td className="px-8 py-6">
                                                    <div className="flex flex-col gap-0.5 font-mono">
                                                        <span className="text-[10px] font-bold text-indigo-600">NIK: {item["nik_ktp(*+16 digit)"]}</span>
                                                        <span className="text-[9px] text-slate-300">KK: {item["no_kk(*+16 digit)"]}</span>
                                                    </div>
                                                </td>
                                                <td className="px-8 py-6 text-right">
                                                    <button onClick={() => setDataMaster(dataMaster.filter((_, idx) => idx !== i))} className="p-2 text-red-200 hover:text-red-500 rounded-lg transition-all">
                                                        <Icon name="Trash2" size={18}/>
                                                    </button>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Modal Pengaturan */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center p-6 z-50">
                            <div className="bg-white w-full max-w-sm rounded-[2.5rem] p-10 shadow-2xl">
                                <div className="flex items-center gap-4 mb-6">
                                    <div className="bg-indigo-50 p-4 rounded-2xl">
                                        <Icon name="Key" className="text-indigo-600" size={24} />
                                    </div>
                                    <h3 className="text-xs font-black uppercase tracking-widest text-slate-800">Pengaturan API</h3>
                                </div>
                                <p className="text-[10px] text-slate-400 mb-6 leading-relaxed">Ganti API Key jika terjadi error "Leaked" atau jika Anda memiliki Key pribadi yang lebih cepat.</p>
                                <input 
                                    type="password"
                                    className="w-full bg-slate-50 border border-slate-100 rounded-2xl px-6 py-4 text-sm mb-8 outline-none focus:ring-2 focus:ring-indigo-500 transition-all font-mono"
                                    placeholder="Masukkan Gemini API Key..."
                                    value={userApiKey}
                                    onChange={(e) => saveApiKey(e.target.value)}
                                />
                                <button onClick={() => setShowSettings(false)} className="w-full bg-slate-900 text-white py-5 rounded-2xl font-bold text-xs uppercase tracking-[0.2em] shadow-lg hover:bg-indigo-600 transition-all">Terapkan Key</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>