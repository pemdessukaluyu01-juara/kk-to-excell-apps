import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getFirestore, collection, addDoc, onSnapshot, query, doc, updateDoc, deleteDoc } from 'firebase/firestore';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { Upload, FileSpreadsheet, Camera, Trash2, Save, Loader2, AlertCircle, CheckCircle2 } from 'lucide-react';

const apiKey = ""; // Diset otomatis oleh environment

const App = () => {
  const [loading, setLoading] = useState(false);
  const [dataMaster, setDataMaster] = useState([]);
  const [imagePreview, setImagePreview] = useState(null);
  const [statusMsg, setStatusMsg] = useState({ type: '', text: '' });

  // Fungsi ekstraksi data menggunakan Gemini Vision
  const extractDataFromImage = async (base64Image) => {
    setLoading(true);
    setStatusMsg({ type: 'info', text: 'Sedang menganalisis foto Kartu Keluarga...' });

    const systemPrompt = `
      Anda adalah ekstraktor data KTP/KK profesional. 
      Tugas: Ekstrak data dari gambar KARTU KELUARGA ke format JSON.
      Aturan:
      1. Ambil "No. KK" (16 digit angka di bagian atas).
      2. Ekstrak tabel anggota keluarga yang berisi: NIK (16 digit), Nama Lengkap, Jenis Kelamin, Alamat, RT, RW, Tanggal Lahir (YYYY-MM-DD), Agama, Pendidikan, Pekerjaan, Golongan Darah, dan Kewarganegaraan.
      3. Jika data tidak ditemukan, biarkan string kosong "".
      4. Pastikan relasi antar kolom dalam satu baris benar.
      5. Cari kata kunci "KARTU KELUARGA" di bagian atas untuk verifikasi.
      
      Format JSON yang diminta:
      {
        "no_kk": "16_digit_angka",
        "anggota": [
          {
            "nik": "16_digit",
            "nama": "NAMA LENGKAP",
            "kelamin": "Laki-laki/Perempuan",
            "alamat": "ALAMAT",
            "rt": "000",
            "rw": "000",
            "tgl_lahir": "YYYY-MM-DD",
            "agama": "AGAMA",
            "pendidikan": "PENDIDIKAN",
            "pekerjaan": "PEKERJAAN",
            "gol_darah": "A/B/AB/O",
            "kewarganegaraan": "WNI/WNA"
          }
        ]
      }
    `;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [
              { text: "Ekstrak data dari foto Kartu Keluarga ini sesuai instruksi." },
              { inlineData: { mimeType: "image/jpeg", data: base64Image.split(',')[1] } }
            ]
          }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
          generationConfig: { responseMimeType: "application/json" }
        })
      });

      const result = await response.json();
      const extractedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
      
      if (extractedText) {
        const parsed = JSON.parse(extractedText);
        processExtractedData(parsed);
        setStatusMsg({ type: 'success', text: 'Data berhasil diekstrak!' });
      }
    } catch (error) {
      console.error(error);
      setStatusMsg({ type: 'error', text: 'Gagal mengekstrak data. Pastikan foto jelas dan terang.' });
    } finally {
      setLoading(false);
    }
  };

  const processExtractedData = (data) => {
    const startNo = dataMaster.length + 1;
    const newRows = data.anggota.map((person, index) => ({
      no_urut: startNo + index,
      no_kk: `*${data.no_kk}`,
      nik_ktp: `*${person.nik}`,
      nama: person.nama,
      kelamin: person.kelamin,
      alamat: person.alamat,
      rt: person.rt,
      rw: person.rw,
      tgl_lahir: person.tgl_lahir,
      agama: person.agama,
      pendidikan: person.pendidikan,
      status_tinggal: "Menetap", // Default sesuai template
      pekerjaan: person.pekerjaan,
      gol_darah: person.gol_darah || "-",
      kewarganegaraan: person.kewarganegaraan || "WNI",
      keterangan: ""
    }));

    setDataMaster(prev => [...prev, ...newRows]);
  };

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setImagePreview(reader.result);
        extractDataFromImage(reader.result);
      };
      reader.readAsDataURL(file);
    }
  };

  const downloadXLSX = () => {
    // Simulasi pembuatan CSV (bisa dibuka di Excel)
    const headers = ["No Urut", "no_kk(*+16 digit)", "nik_ktp(*+16 digit)", "nama", "kelamin", "alamat", "rt", "rw", "tgl_lahir", "agama", "pendidikan", "status_tinggal", "pekerjaan", "golongan darah", "Kewarganegaraan", "Keterangan"];
    const rows = dataMaster.map(d => [
      d.no_urut, d.no_kk, d.nik_ktp, d.nama, d.kelamin, d.alamat, d.rt, d.rw, d.tgl_lahir, d.agama, d.pendidikan, d.status_tinggal, d.pekerjaan, d.gol_darah, d.kewarganegaraan, d.keterangan
    ]);

    const csvContent = [headers, ...rows].map(e => e.join(",")).join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `Master_Warga_${new Date().getTime()}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-800">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
          <div>
            <h1 className="text-3xl font-bold text-indigo-900">KK to Master Excel</h1>
            <p className="text-slate-500">Ekstrak data Kartu Keluarga otomatis menggunakan AI</p>
          </div>
          <div className="flex gap-2">
            <button 
              onClick={() => setDataMaster([])}
              className="px-4 py-2 border border-red-200 text-red-600 rounded-lg hover:bg-red-50 transition flex items-center gap-2"
            >
              <Trash2 size={18} /> Reset
            </button>
            <button 
              onClick={downloadXLSX}
              disabled={dataMaster.length === 0}
              className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 transition flex items-center gap-2 shadow-sm"
            >
              <FileSpreadsheet size={18} /> Export CSV/Excel
            </button>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Upload Area */}
          <div className="lg:col-span-1 space-y-6">
            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
              <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                <Camera size={20} className="text-indigo-600" />
                Upload Foto KK
              </h2>
              
              <div className="relative group">
                <input 
                  type="file" 
                  accept="image/*" 
                  onChange={handleFileUpload}
                  className="hidden" 
                  id="kk-upload"
                  disabled={loading}
                />
                <label 
                  htmlFor="kk-upload"
                  className={`flex flex-col items-center justify-center w-full h-64 border-2 border-dashed rounded-xl cursor-pointer transition
                    ${loading ? 'bg-slate-50 border-slate-200' : 'bg-indigo-50/30 border-indigo-200 hover:border-indigo-400 group-hover:bg-indigo-50'}`}
                >
                  {loading ? (
                    <div className="flex flex-col items-center">
                      <Loader2 className="animate-spin text-indigo-600 mb-2" size={40} />
                      <p className="text-sm text-indigo-600 font-medium">Menganalisis...</p>
                    </div>
                  ) : (
                    <>
                      <Upload className="text-indigo-500 mb-2" size={32} />
                      <p className="text-sm font-medium text-slate-700">Klik untuk upload atau drag foto</p>
                      <p className="text-xs text-slate-400 mt-1 text-center px-4">Pastikan tulisan "KARTU KELUARGA" dan tabel terbaca jelas</p>
                    </>
                  )}
                </label>
              </div>

              {imagePreview && (
                <div className="mt-4 rounded-lg overflow-hidden border border-slate-200">
                  <img src={imagePreview} alt="Preview" className="w-full h-auto max-h-48 object-cover" />
                </div>
              )}

              {statusMsg.text && (
                <div className={`mt-4 p-3 rounded-lg flex items-start gap-3 text-sm ${
                  statusMsg.type === 'error' ? 'bg-red-50 text-red-700 border border-red-100' : 
                  statusMsg.type === 'success' ? 'bg-emerald-50 text-emerald-700 border border-emerald-100' : 
                  'bg-blue-50 text-blue-700 border border-blue-100'
                }`}>
                  {statusMsg.type === 'error' ? <AlertCircle size={18} className="shrink-0" /> : <CheckCircle2 size={18} className="shrink-0" />}
                  {statusMsg.text}
                </div>
              )}
            </div>

            <div className="bg-indigo-900 text-white p-6 rounded-2xl shadow-lg">
              <h3 className="font-semibold mb-2 flex items-center gap-2">
                <AlertCircle size={18} /> Instruksi Sistem
              </h3>
              <ul className="text-xs space-y-2 opacity-90 list-disc ml-4">
                <li>No Urut akan digenerate otomatis.</li>
                <li>No KK & NIK akan otomatis ditambah prefix <b>*</b> untuk mencegah format angka Excel berubah.</li>
                <li>Hanya foto dengan tulisan "KARTU KELUARGA" yang akan diproses secara akurat.</li>
                <li>Data Master akan ditambahkan di baris paling akhir setiap ada upload baru.</li>
              </ul>
            </div>
          </div>

          {/* Table Area */}
          <div className="lg:col-span-2">
            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
              <div className="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <h2 className="font-semibold text-slate-700">Preview Data Master</h2>
                <span className="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full font-medium">
                  {dataMaster.length} Baris Terdeteksi
                </span>
              </div>
              
              <div className="overflow-x-auto max-h-[600px]">
                <table className="w-full text-left text-sm border-collapse">
                  <thead className="sticky top-0 bg-white shadow-sm z-10">
                    <tr className="bg-slate-50 text-slate-500 uppercase text-[10px] tracking-wider">
                      <th className="px-4 py-3 font-semibold border-b">No</th>
                      <th className="px-4 py-3 font-semibold border-b">No KK</th>
                      <th className="px-4 py-3 font-semibold border-b">NIK</th>
                      <th className="px-4 py-3 font-semibold border-b">Nama Lengkap</th>
                      <th className="px-4 py-3 font-semibold border-b">Tgl Lahir</th>
                      <th className="px-4 py-3 font-semibold border-b">Pekerjaan</th>
                      <th className="px-4 py-3 font-semibold border-b">Aksi</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    {dataMaster.length === 0 ? (
                      <tr>
                        <td colSpan="7" className="px-4 py-20 text-center text-slate-400 italic">
                          Belum ada data. Silakan upload foto Kartu Keluarga.
                        </td>
                      </tr>
                    ) : (
                      dataMaster.map((row, idx) => (
                        <tr key={idx} className="hover:bg-slate-50/80 transition">
                          <td className="px-4 py-3 font-medium text-slate-400">{row.no_urut}</td>
                          <td className="px-4 py-3 font-mono text-xs text-indigo-600">{row.no_kk}</td>
                          <td className="px-4 py-3 font-mono text-xs text-indigo-600">{row.nik_ktp}</td>
                          <td className="px-4 py-3 font-semibold">{row.nama}</td>
                          <td className="px-4 py-3 text-slate-500">{row.tgl_lahir}</td>
                          <td className="px-4 py-3 text-slate-500">{row.pekerjaan}</td>
                          <td className="px-4 py-3">
                            <button 
                              onClick={() => setDataMaster(dataMaster.filter((_, i) => i !== idx))}
                              className="text-slate-300 hover:text-red-500 transition"
                            >
                              <Trash2 size={16} />
                            </button>
                          </td>
                        </tr>
                      ))
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default App;


Varian kedua : KK Cloud Collector
Versi berbasis cloud, data akses bersama tersimpan dalam satu folder cloud

import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getFirestore, collection, onSnapshot, query, addDoc, serverTimestamp, orderBy } from 'firebase/firestore';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { Upload, FileSpreadsheet, Camera, Trash2, Loader2, AlertCircle, CheckCircle2, Users, Cloud } from 'lucide-react';

// Import SheetJS untuk export Excel asli (.xlsx)
const XLSX_SCRIPT_URL = "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js";

// Firebase Configuration dari environment
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

const apiKey = ""; // Google AI API Key

const App = () => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(false);
  const [dataMaster, setDataMaster] = useState([]);
  const [imagePreview, setImagePreview] = useState(null);
  const [statusMsg, setStatusMsg] = useState({ type: '', text: '' });

  // 1. Authentikasi (Rule 3)
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Auth error:", err);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // 2. Load Library XLSX
  useEffect(() => {
    const script = document.createElement("script");
    script.src = XLSX_SCRIPT_URL;
    document.head.appendChild(script);
  }, []);

  // 3. Ambil Data Real-time dari Firestore (Rule 1 & 2)
  useEffect(() => {
    if (!user) return;

    // Mengambil data dari koleksi publik agar semua orang bisa melihat data yang terkumpul
    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'warga_master'));
    
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // Sorting manual di memori (Rule 2)
      const sorted = docs.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
      setDataMaster(sorted);
    }, (error) => {
      console.error("Firestore Error:", error);
    });

    return () => unsubscribe();
  }, [user]);

  const extractDataFromImage = async (base64Image) => {
    setLoading(true);
    setStatusMsg({ type: 'info', text: 'AI sedang membaca data KK...' });

    const systemPrompt = `
      Anda adalah ekstraktor data profesional. Ekstrak data Kartu Keluarga ke JSON.
      Aturan: Ambil No KK (16 digit) dan daftar semua anggota (NIK, Nama, Kelamin, Alamat, RT, RW, Tgl Lahir, Agama, Pendidikan, Pekerjaan, Gol Darah, Kewarganegaraan).
      Gunakan format JSON: { "no_kk": "...", "anggota": [{...}] }
    `;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [
              { text: "Ekstrak data KK ini." },
              { inlineData: { mimeType: "image/jpeg", data: base64Image.split(',')[1] } }
            ]
          }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
          generationConfig: { responseMimeType: "application/json" }
        })
      });

      const result = await response.json();
      const extractedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
      
      if (extractedText) {
        const parsed = JSON.parse(extractedText);
        await saveDataToCloud(parsed);
        setStatusMsg({ type: 'success', text: 'Data berhasil disimpan ke Cloud!' });
      }
    } catch (error) {
      setStatusMsg({ type: 'error', text: 'Gagal memproses gambar.' });
    } finally {
      setLoading(false);
    }
  };

  const saveDataToCloud = async (data) => {
    if (!user) return;
    
    const batchPromises = data.anggota.map(person => {
      return addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'warga_master'), {
        no_kk: `*${data.no_kk}`,
        nik_ktp: `*${person.nik}`,
        nama: person.nama,
        kelamin: person.kelamin,
        alamat: person.alamat,
        rt: person.rt,
        rw: person.rw,
        tgl_lahir: person.tgl_lahir,
        agama: person.agama,
        pendidikan: person.pendidikan,
        status_tinggal: "Menetap",
        pekerjaan: person.pekerjaan,
        gol_darah: person.gol_darah || "-",
        kewarganegaraan: person.kewarganegaraan || "WNI",
        keterangan: `Diinput oleh: ${user.uid.substring(0, 5)}`,
        createdAt: serverTimestamp()
      });
    });

    await Promise.all(batchPromises);
  };

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setImagePreview(reader.result);
        extractDataFromImage(reader.result);
      };
      reader.readAsDataURL(file);
    }
  };

  const downloadExcel = () => {
    if (!window.XLSX) return;

    const excelData = dataMaster.map((d, index) => ({
      "No Urut": index + 1,
      "no_kk(*+16 digit)": d.no_kk,
      "nik_ktp(*+16 digit)": d.nik_ktp,
      "nama": d.nama,
      "kelamin": d.kelamin,
      "alamat": d.alamat,
      "rt": d.rt,
      "rw": d.rw,
      "tgl_lahir": d.tgl_lahir,
      "agama": d.agama,
      "pendidikan": d.pendidikan,
      "status_tinggal": d.status_tinggal,
      "pekerjaan": d.pekerjaan,
      "golongan darah": d.gol_darah,
      "Kewarganegaraan": d.kewarganegaraan,
      "Keterangan": d.keterangan
    }));

    const worksheet = window.XLSX.utils.json_to_sheet(excelData);
    const workbook = window.XLSX.utils.book_new();
    window.XLSX.utils.book_append_sheet(workbook, worksheet, "Master");
    window.XLSX.writeFile(workbook, `Rekap_Data_Warga_${new Date().toLocaleDateString()}.xlsx`);
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800">
      {/* Navbar */}
      <nav className="bg-indigo-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div className="max-w-7xl mx-auto flex justify-between items-center">
          <div className="flex items-center gap-2">
            <Cloud className="text-indigo-300" />
            <h1 className="font-bold text-xl tracking-tight">KK Cloud Collector</h1>
          </div>
          <div className="flex items-center gap-4 text-xs">
            <div className="hidden md:block text-right">
              <p className="opacity-70">Status Koneksi</p>
              <p className="font-mono text-emerald-400 flex items-center gap-1 justify-end">
                <span className="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></span> Terhubung
              </p>
            </div>
            {user && (
              <div className="bg-indigo-800 px-3 py-1 rounded-full border border-indigo-700">
                ID Sesi: {user.uid}
              </div>
            )}
          </div>
        </div>
      </nav>

      <div className="max-w-7xl mx-auto p-4 md:p-8">
        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
          
          {/* Sisi Kiri: Kontrol */}
          <div className="lg:col-span-4 space-y-6">
            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
              <h2 className="text-lg font-bold mb-4 flex items-center gap-2 text-indigo-900">
                <Camera size={20} /> Ambil Foto Baru
              </h2>
              
              <input type="file" accept="image/*" onChange={handleFileUpload} className="hidden" id="kk-upload" disabled={loading} />
              <label 
                htmlFor="kk-upload"
                className={`flex flex-col items-center justify-center w-full h-48 border-2 border-dashed rounded-xl cursor-pointer transition
                  ${loading ? 'bg-slate-50 border-slate-200' : 'bg-indigo-50/30 border-indigo-200 hover:border-indigo-400'}`}
              >
                {loading ? (
                  <Loader2 className="animate-spin text-indigo-600" size={32} />
                ) : (
                  <>
                    <Upload className="text-indigo-500 mb-2" size={32} />
                    <p className="text-sm font-semibold">Klik untuk Scan KK</p>
                  </>
                )}
              </label>

              {statusMsg.text && (
                <div className={`mt-4 p-3 rounded-lg text-xs flex gap-2 ${statusMsg.type === 'error' ? 'bg-red-50 text-red-600' : 'bg-emerald-50 text-emerald-600'}`}>
                  {statusMsg.type === 'error' ? <AlertCircle size={14} /> : <CheckCircle2 size={14} />}
                  {statusMsg.text}
                </div>
              )}
            </div>

            <div className="bg-indigo-50 p-6 rounded-2xl border border-indigo-100">
              <h3 className="font-bold text-indigo-900 mb-2 flex items-center gap-2">
                <Users size={18} /> Info Kolaborasi
              </h3>
              <p className="text-xs text-indigo-700 leading-relaxed">
                Aplikasi ini terhubung ke database awan. Data yang Anda upload akan langsung muncul di komputer lain yang membuka aplikasi ini. Cocok untuk kerja tim pendataan warga.
              </p>
            </div>

            <button 
              onClick={downloadExcel}
              disabled={dataMaster.length === 0}
              className="w-full py-4 bg-emerald-600 text-white rounded-2xl font-bold hover:bg-emerald-700 shadow-lg shadow-emerald-200 transition flex items-center justify-center gap-2 disabled:grayscale"
            >
              <FileSpreadsheet size={20} /> Download Master Excel (.xlsx)
            </button>
          </div>

          {/* Sisi Kanan: Tabel Data Bersama */}
          <div className="lg:col-span-8">
            <div className="bg-white rounded-2xl shadow-md border border-slate-200 overflow-hidden">
              <div className="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <div>
                  <h2 className="font-bold text-slate-800">Data Terkumpul (Cloud)</h2>
                  <p className="text-[10px] text-slate-400 uppercase tracking-widest">Total: {dataMaster.length} Anggota Keluarga</p>
                </div>
              </div>

              <div className="overflow-x-auto max-h-[70vh]">
                <table className="w-full text-left text-xs border-collapse">
                  <thead className="sticky top-0 bg-white z-10 shadow-sm">
                    <tr className="bg-slate-100 text-slate-500">
                      <th className="p-3 border-b">No</th>
                      <th className="p-3 border-b">Nama Lengkap</th>
                      <th className="p-3 border-b">NIK</th>
                      <th className="p-3 border-b">Pekerjaan</th>
                      <th className="p-3 border-b">Input Oleh</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    {dataMaster.length === 0 ? (
                      <tr>
                        <td colSpan="5" className="p-10 text-center text-slate-400 italic">Belum ada data di cloud. Silakan mulai mengunggah.</td>
                      </tr>
                    ) : (
                      dataMaster.map((row, idx) => (
                        <tr key={row.id} className="hover:bg-indigo-50/30">
                          <td className="p-3 text-slate-400">{idx + 1}</td>
                          <td className="p-3 font-bold text-slate-700">{row.nama}</td>
                          <td className="p-3 font-mono text-indigo-600">{row.nik_ktp}</td>
                          <td className="p-3">{row.pekerjaan}</td>
                          <td className="p-3 text-[10px] text-slate-400 uppercase">{row.keterangan || 'Sistem'}</td>
                        </tr>
                      ))
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  );
};

export default App;


Versi balik lagi stabil :

import React, { useState, useEffect } from 'react';
import { Upload, FileSpreadsheet, Camera, Trash2, Loader2, AlertCircle, CheckCircle2 } from 'lucide-react';

// Import SheetJS untuk export Excel asli (.xlsx) agar format angka tidak rusak
const XLSX_SCRIPT_URL = "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js";

const apiKey = ""; // API Key disediakan oleh environment

const App = () => {
  const [loading, setLoading] = useState(false);
  const [dataMaster, setDataMaster] = useState([]);
  const [imagePreview, setImagePreview] = useState(null);
  const [statusMsg, setStatusMsg] = useState({ type: '', text: '' });

  // Load library XLSX untuk export Excel berkualitas
  useEffect(() => {
    const script = document.createElement("script");
    script.src = XLSX_SCRIPT_URL;
    document.head.appendChild(script);
  }, []);

  const extractDataFromImage = async (base64Image) => {
    setLoading(true);
    setStatusMsg({ type: 'info', text: 'Sedang menganalisis foto Kartu Keluarga...' });

    // Prompt yang lebih ketat untuk menghindari baris sampah
    const systemPrompt = `
      Anda adalah ekstraktor data Kartu Keluarga profesional. 
      Tugas: Ekstrak data dari gambar KARTU KELUARGA ke format JSON.
      
      ATURAN KETAT:
      1. Ambil "No. KK" (16 digit angka di bagian atas).
      2. Ekstrak tabel anggota keluarga hanya jika "Nama Lengkap" dan "NIK" terbaca jelas.
      3. JANGAN memasukkan baris kosong atau data dari bagian luar tabel (seperti nama Pejabat/Lurah di bawah).
      4. Pastikan jumlah objek dalam array "anggota" sama persis dengan jumlah baris nama yang ada di tabel KK tersebut.
      5. Bersihkan karakter aneh yang bukan bagian dari nama atau angka.
      
      Format JSON: { "no_kk": "...", "anggota": [{ "nik": "...", "nama": "...", "kelamin": "...", "alamat": "...", "rt": "...", "rw": "...", "tgl_lahir": "...", "agama": "...", "pendidikan": "...", "pekerjaan": "...", "gol_darah": "...", "kewarganegaraan": "..." }] }
    `;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [
              { text: "Hanya ekstrak baris yang berisi data anggota keluarga asli. Abaikan tanda tangan atau teks di bawah tabel." },
              { inlineData: { mimeType: "image/jpeg", data: base64Image.split(',')[1] } }
            ]
          }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
          generationConfig: { responseMimeType: "application/json" }
        })
      });

      const result = await response.json();
      const extractedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
      
      if (extractedText) {
        const parsed = JSON.parse(extractedText);
        // Validasi tambahan di sisi client: hapus anggota yang namanya kosong
        if (parsed.anggota) {
          parsed.anggota = parsed.anggota.filter(p => p.nama && p.nama.trim().length > 1);
        }
        processExtractedData(parsed);
        setStatusMsg({ type: 'success', text: `Berhasil mengekstrak ${parsed.anggota.length} anggota keluarga.` });
      }
    } catch (error) {
      console.error(error);
      setStatusMsg({ type: 'error', text: 'Gagal mengekstrak data. Pastikan foto tegak dan jelas.' });
    } finally {
      setLoading(false);
    }
  };

  const processExtractedData = (data) => {
    const startNo = dataMaster.length + 1;
    const newRows = data.anggota.map((person, index) => ({
      no_urut: startNo + index,
      no_kk: `*${data.no_kk}`,
      nik_ktp: `*${person.nik}`,
      nama: person.nama.toUpperCase(),
      kelamin: person.kelamin,
      alamat: person.alamat,
      rt: person.rt,
      rw: person.rw,
      tgl_lahir: person.tgl_lahir,
      agama: person.agama,
      pendidikan: person.pendidikan,
      status_tinggal: "Menetap",
      pekerjaan: person.pekerjaan.toUpperCase(),
      gol_darah: person.gol_darah || "-",
      kewarganegaraan: person.kewarganegaraan || "WNI",
      keterangan: ""
    }));

    setDataMaster(prev => [...prev, ...newRows]);
  };

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setImagePreview(reader.result);
        extractDataFromImage(reader.result);
      };
      reader.readAsDataURL(file);
    }
  };

  const downloadExcel = () => {
    if (!window.XLSX) return;

    const wsData = dataMaster.map(d => ({
      "No Urut": d.no_urut,
      "no_kk(*+16 digit)": d.no_kk,
      "nik_ktp(*+16 digit)": d.nik_ktp,
      "nama": d.nama,
      "kelamin": d.kelamin,
      "alamat": d.alamat,
      "rt": d.rt,
      "rw": d.rw,
      "tgl_lahir": d.tgl_lahir,
      "agama": d.agama,
      "pendidikan": d.pendidikan,
      "status_tinggal": d.status_tinggal,
      "pekerjaan": d.pekerjaan,
      "golongan darah": d.gol_darah,
      "Kewarganegaraan": d.kewarganegaraan,
      "Keterangan": d.keterangan
    }));

    const ws = window.XLSX.utils.json_to_sheet(wsData);
    const wb = window.XLSX.utils.book_new();
    window.XLSX.utils.book_append_sheet(wb, ws, "Master Warga");
    window.XLSX.writeFile(wb, `Data_KK_Master_${new Date().getTime()}.xlsx`);
  };

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-800">
      <div className="max-w-7xl mx-auto">
        <div className="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
          <div>
            <h1 className="text-3xl font-bold text-indigo-900 tracking-tight">KK to Excel <span className="text-indigo-400 font-light text-xl">Standalone</span></h1>
            <p className="text-slate-500">Ekstraksi akurat baris per baris anggota keluarga.</p>
          </div>
          <div className="flex gap-2">
            <button 
              onClick={() => { setDataMaster([]); setImagePreview(null); setStatusMsg({type:'', text:''}); }}
              className="px-4 py-2 text-slate-500 hover:text-red-600 transition flex items-center gap-2"
            >
              <Trash2 size={18} /> Reset Data
            </button>
            <button 
              onClick={downloadExcel}
              disabled={dataMaster.length === 0}
              className="px-6 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 disabled:opacity-50 transition flex items-center gap-2 shadow-lg"
            >
              <FileSpreadsheet size={18} /> Simpan ke Excel (.xlsx)
            </button>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div className="lg:col-span-1 space-y-6">
            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
              <h2 className="text-lg font-bold mb-4 flex items-center gap-2">
                <Camera size={20} className="text-indigo-600" /> Upload Foto KK
              </h2>
              
              <div className="relative group">
                <input type="file" accept="image/*" onChange={handleFileUpload} className="hidden" id="kk-upload" disabled={loading} />
                <label 
                  htmlFor="kk-upload"
                  className={`flex flex-col items-center justify-center w-full h-64 border-2 border-dashed rounded-2xl cursor-pointer transition
                    ${loading ? 'bg-slate-50 border-slate-200' : 'bg-indigo-50/30 border-indigo-200 hover:border-indigo-400'}`}
                >
                  {loading ? (
                    <div className="flex flex-col items-center">
                      <Loader2 className="animate-spin text-indigo-600 mb-2" size={40} />
                      <p className="text-sm text-indigo-600 font-bold">Sedang Memfilter Baris...</p>
                    </div>
                  ) : (
                    <>
                      <Upload className="text-indigo-500 mb-2" size={32} />
                      <p className="text-sm font-bold text-slate-700 text-center">Pilih atau Seret Foto KK</p>
                    </>
                  )}
                </label>
              </div>

              {imagePreview && (
                <div className="mt-4 rounded-xl overflow-hidden border border-slate-200">
                  <img src={imagePreview} alt="Preview" className="w-full h-auto max-h-40 object-cover opacity-70" />
                </div>
              )}

              {statusMsg.text && (
                <div className={`mt-4 p-4 rounded-xl flex items-start gap-3 text-sm border ${
                  statusMsg.type === 'error' ? 'bg-red-50 text-red-700 border-red-100' : 
                  'bg-emerald-50 text-emerald-700 border-emerald-100'
                }`}>
                  {statusMsg.type === 'error' ? <AlertCircle size={18} className="shrink-0" /> : <CheckCircle2 size={18} className="shrink-0" />}
                  <span className="leading-tight font-medium">{statusMsg.text}</span>
                </div>
              )}
            </div>
          </div>

          <div className="lg:col-span-2">
            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden min-h-[500px]">
              <div className="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h2 className="font-bold text-slate-700">Preview Daftar Anggota</h2>
                <div className="text-[10px] bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full font-bold">
                  {dataMaster.length} BARIS DATA
                </div>
              </div>
              
              <div className="overflow-x-auto">
                <table className="w-full text-left text-xs border-collapse">
                  <thead>
                    <tr className="bg-white text-slate-400 border-b border-slate-100">
                      <th className="px-4 py-4 font-bold">No</th>
                      <th className="px-4 py-4 font-bold">Nama Lengkap</th>
                      <th className="px-4 py-4 font-bold">NIK</th>
                      <th className="px-4 py-4 font-bold">Pekerjaan</th>
                      <th className="px-4 py-4 font-bold">Aksi</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-50">
                    {dataMaster.length === 0 ? (
                      <tr>
                        <td colSpan="5" className="px-4 py-32 text-center text-slate-300 italic">
                          Belum ada baris data.
                        </td>
                      </tr>
                    ) : (
                      dataMaster.map((row, idx) => (
                        <tr key={idx} className="hover:bg-indigo-50/20 transition">
                          <td className="px-4 py-3 text-slate-400">{row.no_urut}</td>
                          <td className="px-4 py-3 font-bold text-slate-800 uppercase">{row.nama}</td>
                          <td className="px-4 py-3 font-mono text-indigo-600">{row.nik_ktp}</td>
                          <td className="px-4 py-3 text-slate-600">{row.pekerjaan}</td>
                          <td className="px-4 py-3">
                            <button 
                              onClick={() => setDataMaster(dataMaster.filter((_, i) => i !== idx))}
                              className="text-slate-300 hover:text-red-500 transition"
                            >
                              <Trash2 size={14} />
                            </button>
                          </td>
                        </tr>
                      ))
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default App;